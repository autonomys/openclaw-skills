name: Publish Skill

on:
  push:
    tags:
      - '*/v*'

jobs:
  publish:
    name: Publish to ClawHub
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Parse tag
        id: tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          SKILL="${TAG%%/v*}"
          # Strip the v prefix â€” clawhub expects bare semver (0.1.0-beta.2, not v0.1.0-beta.2)
          VERSION="${TAG#*/v}"
          echo "skill=$SKILL" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Publishing $SKILL $VERSION"

      - name: Resolve skill directory, name, and discovery tags
        id: meta
        run: |
          case "${{ steps.tag.outputs.skill }}" in
            auto-memory)
              echo "dir=autonomys/auto-memory" >> "$GITHUB_OUTPUT"
              echo "name=Auto Memory" >> "$GITHUB_OUTPUT"
              echo "tags=memory,persistence,decentralized,autonomys,long-term,openclaw" >> "$GITHUB_OUTPUT"
              ;;
            auto-respawn)
              echo "dir=autonomys/auto-respawn" >> "$GITHUB_OUTPUT"
              echo "name=Auto Respawn" >> "$GITHUB_OUTPUT"
              echo "tags=identity,agent-memory,decentralized,autonomys,resurrection,persistence" >> "$GITHUB_OUTPUT"
              ;;
            *)
              echo "Error: Unknown skill '${{ steps.tag.outputs.skill }}'" >&2
              exit 1
              ;;
          esac

      - name: Validate skill directory
        run: |
          if [ ! -f "${{ steps.meta.outputs.dir }}/SKILL.md" ]; then
            echo "Error: SKILL.md not found in ${{ steps.meta.outputs.dir }}" >&2
            exit 1
          fi

      - name: Publish to ClawHub
        env:
          CLAWHUB_TOKEN: ${{ secrets.CLAWHUB_TOKEN }}
        run: |
          npx clawhub login --token "$CLAWHUB_TOKEN" --no-browser
          npx clawhub publish "${{ steps.meta.outputs.dir }}" \
            --slug "${{ steps.tag.outputs.skill }}" \
            --name "${{ steps.meta.outputs.name }}" \
            --version "${{ steps.tag.outputs.version }}" \
            --tags "${{ steps.meta.outputs.tags }}"
